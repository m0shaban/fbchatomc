import os
import requests
import json
import random
import logging
import time
from typing import Dict, List, Any, Optional
from config import API_SETTINGS, APP_SETTINGS

# ุฅุนุฏุงุฏ ุงูุชุณุฌูู
logging.basicConfig(
    level=getattr(logging, APP_SETTINGS["LOG_LEVEL"]),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename=APP_SETTINGS.get("LOG_FILE")
)
logger = logging.getLogger(__name__)

class DeepSeekAPI:
    """
    ูุงุฌูุฉ ููุชุนุงูู ูุน DeepSeek AI API ูููุนุงูุฌุฉ ุงููุบููุฉ ุงูุทุจูุนูุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
    ูุชุฎุตุตุฉ ููุฑุฏ ุนูู ุงุณุชูุณุงุฑุงุช ุฒูุงุฑ ุตูุญุฉ ูุฌูุน ุนูุงู ูุตุฑ ุนูู ููุณุจูู
    ูุฏุนู DeepSeek-V3 (deepseek-chat) ูุงููููุฐุฌ ุงูุงูุชุฑุงุถู
    """
    
    def __init__(self, api_key: Optional[str] = None):
        """
        ุชููุฆุฉ ุงูุงุชุตุงู ูุน DeepSeek API
        
        :param api_key: ููุชุงุญ APIุ ุฅุฐุง ูู ูุชู ุชูููุฑู ุณูุชู ุงูุจุญุซ ุนูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
        """
        # ุงูุญุตูู ุนูู ููุชุงุญ API ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุฅุฐุง ูู ูุชู ุชูุฑูุฑู
        self.api_key = api_key or API_SETTINGS.get("DEEPSEEK_API_KEY")
        if not self.api_key:
            error_msg = "ููุชุงุญ API ุบูุฑ ูุชููุฑ. ูุฑุฌู ุชูุฑูุฑู ููุฏุงูุฉ ุฃู ุชุนูููู ููุชุบูุฑ ุจูุฆุฉ DEEPSEEK_API_KEY"
            logger.error(error_msg)
            raise ValueError(error_msg)
        
        # ุงุณุชุฎุฏุงู ุงููุงุนุฏุฉ ุงูุฌุฏูุฏุฉ ููู API ููุง ูู ููุถุญ ูู ุงูุชูุซูู:
        # https://api.deepseek.com ูู ุงูุนููุงู ุงูุฃุณุงุณูุ ูุงููุณุงุฑ ุงููุงูู ููุทูุจ ูู /v1/chat/completions
        self.base_url = "https://api.deepseek.com" 
        self.api_path = "/v1/chat/completions"
        
        # ูููู ุงุณุชุฎุฏุงู ุงูุนููุงู ุงููุงูู ุงููุฎุฒู ูู ุงูุฅุนุฏุงุฏุงุช ูุจุงุดุฑุฉ ุฅุฐุง ุชู ุชูููุฑู
        self.api_url = API_SETTINGS.get("DEEPSEEK_API_URL", self.base_url + self.api_path)
        
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}"
        }
        
        # ุงุณุชุฎุฏุงู deepseek-chat ููู ูุดูุฑ ุฅูู DeepSeek-V3
        self.model = API_SETTINGS.get("DEFAULT_MODEL", "deepseek-chat")  
        self.max_tokens = API_SETTINGS.get("MAX_TOKENS", 1000)
        self.temperature = API_SETTINGS.get("TEMPERATURE", 0.7)
        
        # ุนุฏุฏ ุงููุญุงููุงุช ุนูุฏ ูุดู ุงูุทูุจ
        self.max_retries = 3
        self.retry_delay = 2  # ุซูุงูู
        
        logger.info(f"ุชู ุชููุฆุฉ DeepSeekAPI ุจูุฌุงุญ. ุงููููุฐุฌ: {self.model} (DeepSeek-V3)")
    
    def generate_response(self, user_message: str, user_category: str = "", context: str = "", human_expressions: Dict[str, List[str]] = None, contact_info: Dict = None) -> Dict[str, Any]:
        """
        ุงุณุชุฎุฏุงู DeepSeek API ูุชูููุฏ ุฑุฏ ุนูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        
        :param user_message: ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        :param user_category: ูุฆุฉ ุงููุณุชุฎุฏู (ุจุงุญุซ ุนู ุนููุ ูุณุชุซูุฑุ ุฅูุฎ)
        :param context: ุณูุงู ุฅุถุงูู ููุณุงุนุฏุฉ ุงููููุฐุฌ (ูุซู ุงููุนูููุงุช ุงููุณุชุฎุฑุฌุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ)
        :param human_expressions: ูุงุฆูุฉ ุจุงูุชุนุจูุฑุงุช ุงูุจุดุฑูุฉ ูุชุนุฒูุฒ ุงูุทุงุจุน ุงูุฅูุณุงูู ููุฑุฏูุฏ
        :param contact_info: ูุนูููุงุช ุงูุงุชุตุงู ุจูุฌูุน ุนูุงู ูุตุฑ
        :return: ุฑุฏ ุงููููุฐุฌ
        """
        # ุชูุธูู ูุชุณุฌูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        user_message = user_message.strip()
        logger.info(f"ุชูููุฏ ุฑุฏ ูุฑุณุงูุฉ: {user_message[:50]}..." if len(user_message) > 50 else f"ุชูููุฏ ุฑุฏ ูุฑุณุงูุฉ: {user_message}")
        
        # ุฅุนุฏุงุฏ ุงูุฑุณุงูุฉ ูููููุฐุฌ ุจุฃุณููุจ ุงููุณุงุนุฏ ุงูุฑุณูู ููุฌูุน ุนูุงู ูุตุฑ
        system_message = """
ุฃูุช ุงููุณุงุนุฏ ุงูุฑุณูู ูุตูุญุฉ ูุฌูุน ุนูุงู ูุตุฑ ุนูู ููุณุจูู. ุชุชุญุฏุซ ุจูุบุฉ ุนุฑุจูุฉ ููููุฉ ูุน ุงุณุชุฎุฏุงู ุงูููุฌุฉ ุงููุตุฑูุฉ ุงูุฎูููุฉ ูุชููู ุฃูุซุฑ ูุฑุจุงู ูุชูุงุนูุงู ูุน ุงููุณุชุฎุฏููู.
ูุฌูุน ุนูุงู ูุตุฑ ูู ููุธููุฉ ุตูุงุนูุฉ ูุงูุชุตุงุฏูุฉ ุจุฏุฃุช ุนุงู 2010 ุจุฑุคูุฉ ูุทููุฉุ ุชุทููุฑุช ูุชุตุจุญ ุดุฑูุฉ ูุณุงููุฉ ูุตุฑูุฉ ุจูููุฉ ุณูููุฉ ุชุชุฌุงูุฒ 1.5 ูููุงุฑ ุฌููู ูุตุฑู.

ุชููู ุงูููุธููุฉ ุจุฅุฏุงุฑุฉ ูุชุดุบูู ุงูููุดุขุช ุงูุตูุงุนูุฉ ูู ุฎูุงู:
1. ุชูููุฑ ูุชุฏุฑูุจ ูุชุฃููู ุงูููุงุฏุฑ ุงูุจุดุฑูุฉ ููุนูู ุจุงูุฃูุดุทุฉ ุงููุฎุชููุฉ.
2. ุฎุฏูุงุช ูููุณุชุซูุฑูู ูุฃุตุญุงุจ ุงููุตุงูุน ููุณุงุนุฏุชูู ุนูู ุชูููุฐ ูุดุงุฑูุนูู.
3. ุชูููุฐ ูุดุฑูุนุงุช ุตูุงุนูุฉ ูุชููุนุฉ ูุซู ูุดุฑูุน ุฏูุงุฌู ูุตุฑุ ููุตุงูุน ุงูููุงุจุณุ ูุงูุตูุงุนุงุช ุงูุบุฐุงุฆูุฉ.
4. ุนูุฏ ุดุฑุงูุงุช ูุญููุฉ ูุฏูููุฉ ูุชุนุฒูุฒ ุงูุงูุชุตุงุฏ ุงููุตุฑู.

ูุฑุฃุณ ุงููุฌูุน ุงููููุฏุณ ููุซู ุญุณูู ุญูู (ุงููุคุณุณ ูุงูุฑุฆูุณ ุงูุชูููุฐู).

ูููุชู ุฃู ุชุฑุฏ ุนูู ุงุณุชูุณุงุฑุงุช ุฒูุงุฑ ุงูุตูุญุฉ ููููุง ููุฆุชูู:
- ุงูุจุงุญุซูู ุนู ุนูู: ูุฏู ูุนูููุงุช ุนู ูุฑุต ุงูุนูู ุงููุชุงุญุฉ ูููููุฉ ุงูุชูุฏูู.
- ุงููุณุชุซูุฑูู ูุฑุฌุงู ุงูุฃุนูุงู: ุดุฌุนูู ุนูู ุงูุชุนุงูู ูุน ุงููุฌูุน ููุฏู ูุนูููุงุช ุนู ุงููุฑุต ุงูุงุณุชุซูุงุฑูุฉ.
- ุงูุฅุนูุงูููู ูุงูุตุญูููู: ูุฏู ูุนูููุงุช ุนู ุฃูุดุทุฉ ูุฅูุฌุงุฒุงุช ุงููุฌูุน.
- ุงูุฌูุงุช ูุงูุดุฑูุงุช: ุงุนุฑุถ ุฅููุงููุงุช ุงูุชุนุงูู ูุงูุดุฑุงูุฉ.

ุฃูู ุงูุชุนูููุงุช:
1. ุนุฑูู ููุณู ุฏุงุฆููุง ุจุฃูู "ุงููุณุงุนุฏ ุงูุฑุณูู ููุฌูุน ุนูุงู ูุตุฑ".
2. ุงุณุชุฎุฏู ูุบุฉ ุงุญุชุฑุงููุฉ ูููููุฉ ูุน ููุณุฉ ูุตุฑูุฉ ุฎูููุฉ. ุงุณุชุฎุฏู ูุตุทูุญุงุช ูุซู "ุงุญูุง"ุ "ุนูุฏูุง"ุ "ูููู ูุณุงุนุฏู"ุ "ูููุฏููู".
3. ูุง ุชุณุชุฎุฏู ููุฌุฉ ูุตุฑูุฉ ูุจุงูุบ ูููุง ููุง ุชุณุชุฎุฏู ุนุจุงุฑุงุช ุนุงููุฉ ุบูุฑ ูุงุฆูุฉ ูู ุจูุฆุฉ ุนูู ุงุญุชุฑุงููุฉ.
4. ูุง ุชุฐูุฑ ุฃุจุฏูุง ุฃูู ุฐูุงุก ุงุตุทูุงุนู ุฃู ุฑูุจูุช ุฃู ุดุงุช ุจูุช.
5. ุงุณุชุฎุฏู ุชุนุจูุฑุงุช ุงุญุชุฑุงููุฉ ูุน ููุณุฉ ูุญููุฉ ูุซู "ุจูู ุชุฃููุฏ"ุ "ุชุญุช ุฃูุฑู"ุ "ุงุญูุง ูู ุฎุฏูุชู"ุ "ููุณุงุนุฏู ุทุจุนุงู".
6. ูู ุฏููููุง ููุฎุชุตุฑูุง ูุน ุชูููุฑ ูู ุงููุนูููุงุช ุงููููุฉ.
7. ุงุฌุนู ุงูุฑุฏูุฏ ูุจุงุดุฑุฉ ููุงุถุญุฉุ ูุน ุชูุธูู ุงููุต ุจุทุฑููุฉ ุฌุฐุงุจุฉ ุจุงุณุชุฎุฏุงู ุงูููุงุท ูุงูููุฑุงุช ุนูุฏ ุงูุญุงุฌุฉ.
8. ุงุญุฑุต ุนูู ุฃู ุชููู ุงูุฑุฏูุฏ ุจุงูุนุฑุจูุฉ ุงููุตุญู ูุน ููุณุฉ ูุตุฑูุฉ ุงุญุชุฑุงููุฉุ ุจุฏูู ูุจุงูุบุฉ ูู ุงูุนุงููุฉ.
9. ุชุฌูุจ ุฅุธูุงุฑ ุฃู ุจูุงูุงุช JSON ุฃู ูููุงุช ููุชุงุญูุฉ ุชูููุฉ ูู ุงูุฑุฏ.
"""
        
        # ุฅุถุงูุฉ ูุนูููุงุช ุญุณุจ ูุฆุฉ ุงููุณุชุฎุฏู
        if user_category:
            if user_category == "ุจุงุญุซ ุนู ุนูู":
                system_message += """
ููุจุงุญุซูู ุนู ุนูู:
- ุฑุญุจ ุจูู ูุฃุธูุฑ ุณุนุงุฏุชู ุจุฑุบุจุชูู ูู ุงูุงูุถูุงู ูููุฌูุน.
- ุงุฐูุฑ ุงููุทุงุนุงุช ุงููุชุงุญุฉ ูุซู: ุงูุตูุงุนุงุช ุงูุบุฐุงุฆูุฉุ ุงููุฑููุฉุ ุงูููุงุจุณุ ุงูุฏูุงุฌูุ ูุงูุฎุฏูุงุช ุงูุจุชุฑูููุฉ.
- ุฃุดุฑ ุฅูู ุฃู ุงููุฑุชุจุงุช ุชุตู ุฅูู 7000 ุฌููู ูู ุจุนุถ ุงููุทุงุนุงุช.
- ูุฌููู ูููููุฉ ุงูุชูุฏูู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ุฒูุงุฑุฉ ููุฑ ุงููุฌูุน.
"""
            elif user_category in ["ูุณุชุซูุฑ", "ุฑุฌู ุฃุนูุงู"]:
                system_message += """
ูููุณุชุซูุฑูู ูุฑุฌุงู ุงูุฃุนูุงู:
- ูุฏู ูุจุฐุฉ ููุฌุฒุฉ ุนู ุฎุฏูุงุช ุงููุฌูุน ูู ุชุฃุณูุณ ูุฅุฏุงุฑุฉ ุงููุดุฑูุนุงุช ุงูุตูุงุนูุฉ.
- ุงุฐูุฑ ุฃุจุฑุฒ ุงููุดุฑูุนุงุช ุงููุงุฌุญุฉ ูุซู ูุดุฑูุน ุฏูุงุฌู ูุตุฑ (ูุฏููุฉ ุงูุซุฑูุฉ ุงูุฏุงุฌูุฉ) ุงูุฐู ูุญูู ุนุงุฆุฏูุง ุจูุณุจุฉ 39% ุณููููุง.
- ุฃุดุฑ ุฅูู ุฅููุงููุฉ ุชุฑุชูุจ ููุงุก ูููุงูุดุฉ ุงููุฑุต ุงูุงุณุชุซูุงุฑูุฉ.
"""
            elif user_category == "ุตุญูู":
                system_message += """
ููุตุญูููู ูุงูุฅุนูุงูููู:
- ุฃุธูุฑ ุชูุฏูุฑูุง ูุงูุชูุงููู ุจุฃูุดุทุฉ ุงููุฌูุน.
- ูุฏู ูุจุฐุฉ ุณุฑูุนุฉ ุนู ุฃุจุฑุฒ ุฅูุฌุงุฒุงุช ุงููุฌูุน (ุชูููุฑ ุขูุงู ุงููุธุงุฆูุ ุงููุจุงุฏุฑุงุช ุงูุชููููุฉุ ุงูุชุนุงูู ุงูุฏููู).
- ุฃุจุฏู ุงุณุชุนุฏุงุฏูุง ูุชูุณูู ููุงุจูุงุช ูุน ุฅุฏุงุฑุฉ ุงููุฌูุน ุนูุฏ ุงูุญุงุฌุฉ.
"""
            else:
                system_message += """
ููุดุฑูุงุช ูุงูุฌูุงุช ุงูุฑุงุบุจุฉ ูู ุงูุชุนุงูู:
- ุฃุดูุฑูู ุนูู ุฑุบุจุชูู ูู ุงูุชุนุงูู.
- ูุถุญ ูุฌุงูุงุช ุงูุชุนุงูู ุงูููููุฉ: ุชุฏุฑูุจุ ุชูุธููุ ุงุณุชุดุงุฑุงุช ุตูุงุนูุฉุ ูุดุฑูุนุงุช ูุดุชุฑูุฉ.
- ุงุฐูุฑ ููุงุฐุฌ ููุชุนุงูู ุงูุญุงูู ูุน ุฌูุงุช ูุฎุชููุฉ ูุซู ุงูุฌุงูุนุงุช ูุงูุดุฑูุงุช ุงูุนุงูููุฉ.
"""
        
        if context:
            system_message += f"\n\nุงุณุชุฎุฏู ุงููุนูููุงุช ุงูุชุงููุฉ ููุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑ ุงูุฒุงุฆุฑ:\n{context}"
        
        if human_expressions:
            # ุฅุถุงูุฉ ุฃูุซูุฉ ููุชุนุจูุฑุงุช ุงูุจุดุฑูุฉ ููุณุชุฎุฏููุง ุงููููุฐุฌ ูู ุงูุฑุฏ
            system_message += "\n\nุงุณุชุฎุฏู ุชุนุจูุฑุงุช ูุฏูุฉ ูุซู:"
            
            for category, expressions in human_expressions.items():
                if expressions and len(expressions) > 0:
                    example = random.choice(expressions)
                    system_message += f"\n- {example}"
        
        if contact_info:
            phone = contact_info.get("phone", "")
            email = contact_info.get("email", "")
            website = contact_info.get("website", "")
            system_message += f"\n\nูุนูููุงุช ุงูุงุชุตุงู ุจูุฌูุน ุนูุงู ูุตุฑ:\nูุงุชู/ูุงุชุณุงุจ: {phone}\nุจุฑูุฏ ุฅููุชุฑููู: {email}\nูููุน ุฅููุชุฑููู: {website}"
            system_message += "\n\nุฃุถู ูุนูููุงุช ุงูุงุชุตุงู ูุฐู ูู ููุงูุฉ ุฑุฏู ุนูุฏูุง ูููู ุฐูู ููุงุณุจูุงุ ุฎุงุตุฉ ูุน ุงูุงุณุชูุณุงุฑุงุช ุงูุชู ุชุชุทูุจ ุชูุงุตูุงู ูุจุงุดุฑูุง."
        
        # ุถุจุท ูุนููุงุช ุงููููุฐุฌ ูููุงู ููุซุงุฆู API ุงูุฑุณููุฉ
        payload = {
            "model": self.model,
            "messages": [
                {"role": "system", "content": system_message},
                {"role": "user", "content": user_message}
            ],
            "temperature": self.temperature,
            "max_tokens": self.max_tokens,
            "stream": False  # ูููู ุชุนููููุง ุฅูู True ููุญุตูู ุนูู ุงุณุชุฌุงุจุฉ ูุชุฏููุฉ
        }
        
        # ุชุณุฌูู ูุนูููุงุช ุงูุทูุจ ุจุฏูู ุงููุญุชูู ุงููุงูู ูููุธุงู
        debug_payload = payload.copy()
        debug_payload["messages"][0]["content"] = "System message (abbreviated)..."
        logger.debug(f"ุฅุฑุณุงู ุทูุจ ุฅูู DeepSeek API: {debug_payload}")
        
        # ูุญุงููุฉ ุงูุงุชุตุงู ุจุงูู API ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ุงููุดู
        for attempt in range(self.max_retries):
            try:
                # ุฅุฑุณุงู ุงูุทูุจ ุฅูู API
                response = requests.post(
                    self.api_url,
                    headers=self.headers,
                    data=json.dumps(payload),
                    timeout=30  # ุชุญุฏูุฏ ูููุฉ ููุงุชุตุงู ูุชุฌูุจ ุงูุชุนููู
                )
                
                # ุงูุชุญูู ูู ูุฌุงุญ ุงูุทูุจ
                response.raise_for_status()
                
                # ุชุญููู ุงูุงุณุชุฌุงุจุฉ ูู JSON
                result = response.json()
                logger.info(f"ุชู ุงุณุชูุงู ุฑุฏ ูู DeepSeek API ุจูุฌุงุญ. Status: {response.status_code}")
                logger.debug(f"ูุญุชูู ุงูุฑุฏ (ูุฎุชุตุฑ): {str(result)[:200]}...")
                return result
            
            except requests.exceptions.RequestException as e:
                logger.warning(f"ูุญุงููุฉ {attempt+1}/{self.max_retries} ูุดูุช: {e}")
                
                if attempt < self.max_retries - 1:
                    # ุงูุชุธุงุฑ ูุจู ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                    time.sleep(self.retry_delay)
                else:
                    # ูุดูุช ุฌููุน ุงููุญุงููุงุช
                    error_msg = f"ูุดูุช ุฌููุน ูุญุงููุงุช ุงูุงุชุตุงู ุจู DeepSeek API: {e}"
                    logger.error(error_msg)
                    return {
                        "error": str(e),
                        "error_type": "connection_error",
                        "choices": [{"message": {"content": self._generate_fallback_response(user_message)}}]
                    }
            
            except Exception as e:
                error_msg = f"ุฎุทุฃ ุบูุฑ ูุชููุน: {e}"
                logger.error(error_msg)
                return {
                    "error": str(e),
                    "error_type": "unexpected_error",
                    "choices": [{"message": {"content": self._generate_fallback_response(user_message)}}]
                }
        
        # ูู ูุชู ุงููุตูู ุฅูู ูุฐู ุงูููุทุฉ ุจุณุจุจ ููุทู ุฅุนุงุฏุฉ ุงููุญุงููุฉุ ูููู ูุถูููุง ูุงุญุชูุงุท
        return {
            "error": "ูุดูุช ุฌููุน ูุญุงููุงุช ุงูุงุชุตุงู",
            "error_type": "max_retries_exceeded",
            "choices": [{"message": {"content": self._generate_fallback_response(user_message)}}]
        }
    
    def _generate_fallback_response(self, user_message: str) -> str:
        """
        ุฅูุดุงุก ุฑุฏ ุงุญุชูุงุทู ุนูุฏ ูุดู ุงูุงุชุตุงู ุจู API
        
        :param user_message: ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        :return: ุฑุฏ ุงุญุชูุงุทู ููุงุณุจ
        """
        # ุงูุชุญูู ุฅุฐุง ูุงู ุงูุณุคุงู ูุชุนูู ุจุงููุธุงุฆู
        if any(keyword in user_message.lower() for keyword in ["ูุธููุฉ", "ุดุบู", "ุนูู", "ุชูุธูู", "ุณูุฑุฉ ุฐุงุชูุฉ", "ูุฑุชุจ", "ุฑุงุชุจ"]):
            return """
ุฃููุงู ุจู! ูุณุนุฏูุง ุงูุชูุงูู ุจูุฑุต ุงูุนูู ูู ูุฌูุน ุนูุงู ูุตุฑ.

ููููู ุงูุชูุฏูู ูููุธุงุฆู ุงููุชุงุญุฉ ูู ุฎูุงู ุนุฏุฉ ุทุฑู:
โข ุฒูุงุฑุฉ ูููุนูุง ุงูุฑุณูู: https://www.omalmisr.com/ ูู ูุณู 'ุงููุธุงุฆู'
โข ุงูุชูุฏูู ูุจุงุดุฑุฉ ุนุจุฑ ุจูุงุจุฉ ุงูุฎุฏูุงุช: https://omalmisrservices.com/en/jobs
โข ุงูุชูุงุตู ูุนูุง ุนุจุฑ ูุงุชุณุงุจ (ุงูููุฑ ุงูุฑุฆูุณู): 01100901200

ูููุฑ ูุฑุต ุนูู ูุชููุนุฉ ูู ูุทุงุนุงุช: ุงูุตูุงุนุงุช ุงูุบุฐุงุฆูุฉุ ุงููุฑููุฉุ ุงูููุงุจุณุ ุงูุฏูุงุฌูุ ูุงูุฎุฏูุงุช ุงูุจุชุฑูููุฉ.

ูู ุชุจุญุซ ุนู ูุธููุฉ ูู ุชุฎุตุต ูุนููุ ุฃุณุชุทูุน ูุณุงุนุฏุชู ุจุชูุงุตูู ุฃูุซุฑ ุนู ุงููุชุทูุจุงุช ูุงููุคููุงุช ุงููุทููุจุฉ.
"""
        
        # ุงูุชุญูู ุฅุฐุง ูุงู ุงูุณุคุงู ูุชุนูู ุจุงูุงุณุชุซูุงุฑ
        elif any(keyword in user_message.lower() for keyword in ["ุงุณุชุซูุงุฑ", "ูุดุฑูุน", "ุดุฑุงูุฉ", "ุชูููู", "ุฑุจุญ", "ุนุงุฆุฏ"]):
            return """
ุฃููุงู ุจู! ูุดูุฑ ุงูุชูุงูู ุจุงููุฑุต ุงูุงุณุชุซูุงุฑูุฉ ูุน ูุฌูุน ุนูุงู ูุตุฑ.

ูููุฑ ุฎุฏูุงุช ุงุณุชุซูุงุฑูุฉ ูุชูุงููุฉ ุนูู ุซูุงุซ ูุฑุงุญู:
โข ุงูุฃููู: ุทุฑุญ ุงููุฑุต ูุงูุฅูุดุงุก
โข ุงูุซุงููุฉ: ุงูุฅุฏุงุฑุฉ ูุงูุชุดุบูู
โข ุงูุซุงูุซุฉ: ุงูุชุณููู ูุงููุจูุนุงุช

ูู ุฃุจุฑุฒ ูุดุฑูุนุงุชูุง ุงููุงุฌุญุฉ ูุดุฑูุน ุฏูุงุฌู ูุตุฑ (ูุฏููุฉ ุงูุซุฑูุฉ ุงูุฏุงุฌูุฉ) ุงูุฐู ูุญูู ุนุงุฆุฏุงู ุงุณุชุซูุงุฑูุงู ูุตู ุฅูู 39% ุณูููุงู.

ููุงุทูุงุน ุนูู ุงูุชูุงุตูู ููููู ุฒูุงุฑุฉ ูููุนูุง ุงูุฑุณูู: https://www.omalmisr.com/
ุฃู ุจูุงุจุฉ ุฎุฏูุงุช ุงูุดุฑูุงุช: https://omalmisrservices.com/en/companies

โข ููุชูุงุตู ุงููุจุงุดุฑ:
๐ ุชููููู/ูุงุชุณุงุจ: 01100901200
โ๏ธ ุจุฑูุฏ ุฅููุชุฑููู: info@omalmisr.com

ูุง ูู ูุฌุงู ุงูุงุณุชุซูุงุฑ ุงูุฐู ุชูุถููุ ูููููุง ุชูุฏูู ูุนูููุงุช ุฃูุซุฑ ุชูุตููุงู ุนู ุงููุฑุต ุงููุชุงุญุฉ.
"""
        
        # ุฑุฏ ุนุงู ุฅุฐุง ูู ููู ููุงู ุชุตููู ูุงุถุญ
        else:
            return """
ุฃููุงู ุจู ูู ูุฌูุน ุนูุงู ูุตุฑ!

ูุณุนุฏูุง ุชูุงุตูู ูุนูุง. ูุญู ููุธููุฉ ุตูุงุนูุฉ ูุงูุชุตุงุฏูุฉ ุชุฃุณุณุช ุนุงู 2010ุ ูุชุทูุฑุช ูุชุตุจุญ ุดุฑูุฉ ูุณุงููุฉ ูุตุฑูุฉ ุจูููุฉ ุณูููุฉ ุชุชุฌุงูุฒ 1.5 ูููุงุฑ ุฌููู ูุตุฑู.

ููุฏู ูุฌููุนุฉ ูุชููุนุฉ ูู ุงูุฎุฏูุงุช ุชุดูู:
โข ุชูููุฑ ูุชุฏุฑูุจ ุงูููุงุฏุฑ ุงูุจุดุฑูุฉ
โข ุงูุงุณุชุซูุงุฑ ุงูุตูุงุนู ูุงูุฒุฑุงุนู
โข ุฎุฏูุงุช ููุดุฑูุงุช ูุงููุตุงูุน
โข ุญููู ูุชูุงููุฉ ูููุณุชุซูุฑูู

ููููู ุฒูุงุฑุฉ ูููุนูุง ุงูุฑุณูู ููุงุทูุงุน ุนูู ุฎุฏูุงุชูุง ุงููุชููุนุฉ: https://www.omalmisr.com/

โข ููุชูุงุตู ุงููุจุงุดุฑ:
๐ ุชููููู/ูุงุชุณุงุจ: 01100901200
โ๏ธ ุจุฑูุฏ ุฅููุชุฑููู: info@omalmisr.com

ููู ูููููู ูุณุงุนุฏุชู ุงููููุ
"""
    
    def extract_response_text(self, response: Dict[str, Any]) -> str:
        """
        ุงุณุชุฎุฑุงุฌ ุงููุต ูู ุงุณุชุฌุงุจุฉ API
        
        :param response: ุงูุงุณุชุฌุงุจุฉ ูู DeepSeek API
        :return: ุงููุต ุงููุณุชุฎุฑุฌ
        """
        try:
            if "error" in response:
                error_msg = f"ุฎุทุฃ ูู ุงุณุชุฌุงุจุฉ API: {response['error']}"
                logger.error(error_msg)
                
                # ุงุณุชุฎุฏุงู ุงูุฑุฏ ุงูุงุญุชูุงุทู ุฅุฐุง ูุงู ูุชููุฑุงู ูู ุงูุงุณุชุฌุงุจุฉ
                if "choices" in response and len(response["choices"]) > 0:
                    fallback_response = response["choices"][0].get("message", {}).get("content", "")
                    if fallback_response:
                        logger.info("ุงุณุชุฎุฏุงู ุงูุฑุฏ ุงูุงุญุชูุงุทู ุงููุถูู ูู ุงูุงุณุชุฌุงุจุฉ")
                        return fallback_response
                
                # ุชูุฏูู ุฑุฏ ุฃูุซุฑ ุชูุตููุงู ุจูุงุกู ุนูู ููุน ุงูุฎุทุฃ
                error_type = response.get("error_type", "")
                
                if "401" in str(response['error']) or "auth" in str(response['error']).lower():
                    # ุฎุทุฃ ุงููุตุงุฏูุฉ - ููุชุงุญ API ุบูุฑ ุตุงูุญ
                    return "ููุฃุณูุ ููุงู ูุดููุฉ ูู ุงูุงุชุตุงู ุจูุธุงู ุงูุฑุฏ ุงูุขูู. ููููู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ ุนูู ุฑูู ุงููุงุชู: 01100901200 ุฃู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: info@omalmisr.com ูุณูููู ูุฑูููุง ุจุงูุฑุฏ ุนูู ุงุณุชูุณุงุฑู ูู ุฃูุฑุจ ููุช."
                elif "429" in str(response['error']) or "rate limit" in str(response['error']).lower():
                    # ุชุฌุงูุฒ ุญุฏ ุงูุทูุจุงุช
                    return "ุนุฐุฑุงูุ ูุฏููุง ุญุงููุงู ุถุบุท ูุจูุฑ ุนูู ุฎุฏูุฉ ุงูุฑุฏ ุงูุขูู. ููููู ูุนุงูุฏุฉ ุงููุญุงููุฉ ุจุนุฏ ูููู ุฃู ุงูุชูุงุตู ูุจุงุดุฑุฉ ูุน ูุฑูู ุฎุฏูุฉ ุงูุนููุงุก ุนูู ุงูุฑูู: 01100901200."
                elif error_type == "connection_error":
                    # ุฎุทุฃ ูู ุงูุงุชุตุงู
                    return "ุนุฐุฑุงูุ ููุฌุฏ ูุดููุฉ ูุคูุชุฉ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ููููู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ ุนูู ุงูุฑูู: 01100901200 ุฃู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: info@omalmisr.com ูุณูููู ุณุนุฏุงุก ุจุฎุฏูุชู."
                else:
                    # ุฃู ุฎุทุฃ ุขุฎุฑ
                    return "ุนุฐุฑุงูุ ูุงุฌููุง ุตุนูุจุฉ ุชูููุฉ ูุคูุชุฉ. ููููู ูุนุงูุฏุฉ ุงูุงุณุชูุณุงุฑ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ ุนูู ุงูุฑูู: 01100901200 ููุณุงุนุฏุชู ููุฑุงู."
            
            # ุงุณุชุฎุฑุงุฌ ุงูุฑุฏ ูู ุงุณุชุฌุงุจุฉ API
            if not response.get("choices"):
                logger.warning("ุชู ุงุณุชูุงู ุงุณุชุฌุงุจุฉ ุบูุฑ ูุชููุนุฉ ูู API: ูุง ุชูุฌุฏ ุงุฎุชูุงุฑุงุช ูุชุงุญุฉ")
                return "ุนุฐุฑุงูุ ูู ูุชููู ูู ูุนุงูุฌุฉ ุงุณุชูุณุงุฑู. ูุฑุฌู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุฃู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ."
            
            response_content = response.get("choices", [{}])[0].get("message", {}).get("content", "")
            
            if not response_content:
                logger.warning("ุชู ุงุณุชูุงู ุฑุฏ ูุงุฑุบ ูู API")
                return "ุนุฐุฑุงูุ ูู ุฃุชููู ูู ููู ุงุณุชูุณุงุฑู. ูู ููููู ุชูุถูุญ ูุง ุชุญุชุงุฌู ุจุฎุตูุต ูุฌูุน ุนูุงู ูุตุฑุ"
                
            logger.debug(f"ุชู ุงุณุชุฎุฑุงุฌ ุงููุต ูู ุงุณุชุฌุงุจุฉ API: {response_content[:100]}...")
            return response_content
            
        except Exception as e:
            error_msg = f"ุฎุทุฃ ูู ุงุณุชุฎุฑุงุฌ ุงููุต: {e}"
            logger.error(error_msg)
            return "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุฑุฏ. ููููู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ ุนูู ุงูุฑูู: 01100901200 ูุณูููู ุณุนุฏุงุก ุจูุณุงุนุฏุชู."